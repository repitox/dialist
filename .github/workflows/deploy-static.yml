name: Deploy Static Site

# Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ñ€Ğ¸ Ğ¿ÑƒÑˆĞµ Ğ² main Ğ²ĞµÑ‚ĞºÑƒ
on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    # ĞŸĞ¾Ğ»ÑƒÑ‡Ğ°ĞµĞ¼ ĞºĞ¾Ğ´ Ğ¸Ğ· Ñ€ĞµĞ¿Ğ¾Ğ·Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ñ
    - name: Checkout code
      uses: actions/checkout@v4
    
    # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
    - name: Validate project files
      run: |
        echo "ğŸ” Checking project files..."
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
        if [ ! -f "index.html" ]; then
          echo "âŒ index.html not found!"
          exit 1
        fi
        
        echo "âœ… index.html found"
        
        if [ -f "styles.css" ]; then
          echo "âœ… styles.css found"
        fi
        
        if [ -f "script.js" ]; then
          echo "âœ… script.js found"
        fi
        
        echo "ğŸ“‹ Files to deploy:"
        ls -la *.html *.css *.js *.md 2>/dev/null || echo "Some files may be missing"
    
    # ĞŸĞ¾Ğ´Ğ³Ğ¾Ñ‚Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
    - name: Prepare deployment files
      run: |
        echo "ğŸ“¦ Preparing files for deployment..."
        
        # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ´ĞµĞ¿Ğ»Ğ¾Ñ
        mkdir -p deploy
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
        cp index.html deploy/ 2>/dev/null || echo "âš ï¸ index.html not found"
        cp styles.css deploy/ 2>/dev/null || echo "âš ï¸ styles.css not found"
        cp script.js deploy/ 2>/dev/null || echo "âš ï¸ script.js not found"
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ´Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        cp *.png deploy/ 2>/dev/null || echo "â„¹ï¸ No PNG images found"
        cp *.jpg deploy/ 2>/dev/null || echo "â„¹ï¸ No JPG images found"
        cp *.jpeg deploy/ 2>/dev/null || echo "â„¹ï¸ No JPEG images found"
        cp *.gif deploy/ 2>/dev/null || echo "â„¹ï¸ No GIF images found"
        cp *.svg deploy/ 2>/dev/null || echo "â„¹ï¸ No SVG images found"
        cp *.ico deploy/ 2>/dev/null || echo "â„¹ï¸ No ICO files found"
        
        # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºĞ¸ ĞµÑĞ»Ğ¸ ĞµÑÑ‚ÑŒ
        if [ -d "images" ]; then
          cp -r images deploy/
          echo "âœ… Images folder copied"
        fi
        
        if [ -d "assets" ]; then
          cp -r assets deploy/
          echo "âœ… Assets folder copied"
        fi
        
        if [ -d "css" ]; then
          cp -r css deploy/
          echo "âœ… CSS folder copied"
        fi
        
        if [ -d "js" ]; then
          cp -r js deploy/
          echo "âœ… JS folder copied"
        fi
        
        echo "ğŸ“‹ Files prepared for deployment:"
        ls -la deploy/
        
        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ñ€Ğ°Ğ·Ğ¼ĞµÑ€
        total_size=$(du -sh deploy/ | cut -f1)
        echo "ğŸ“Š Total deployment size: $total_size"
    
    # Ğ”ĞµĞ¿Ğ»Ğ¾Ğ¹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€ Ñ‡ĞµÑ€ĞµĞ· SSH
    - name: Deploy to server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          echo "ğŸš€ Starting deployment process..."
          
          # ĞŸĞµÑ€ĞµÑ…Ğ¾Ğ´Ğ¸Ğ¼ Ğ² Ğ¿Ğ°Ğ¿ĞºÑƒ ÑĞ°Ğ¹Ñ‚Ğ°
          cd ${{ secrets.SERVER_PATH }}
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±ÑĞºĞ°Ğ¿ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          if [ -d "current" ]; then
            echo "ğŸ“¦ Creating backup..."
            rm -rf backup
            mv current backup
            echo "âœ… Backup created"
          fi
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ¿Ğ°Ğ¿ĞºÑƒ Ğ´Ğ»Ñ Ğ½Ğ¾Ğ²Ğ¾Ğ¹ Ğ²ĞµÑ€ÑĞ¸Ğ¸
          mkdir -p current
          echo "ğŸ“ Deployment directory prepared"
    
    # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
    - name: Copy files to server
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        source: "deploy/*"
        target: ${{ secrets.SERVER_PATH }}/current/
        strip_components: 1
    
    # Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€Ğµ
    - name: Finalize deployment
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        port: ${{ secrets.SERVER_PORT }}
        script: |
          cd ${{ secrets.SERVER_PATH }}/current
          
          echo "ğŸ”§ Setting up file permissions..."
          
          # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿Ñ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ°
          chmod -R 644 *
          find . -type d -exec chmod 755 {} \;
          
          # Ğ¡Ğ¿ĞµÑ†Ğ¸Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ»Ñ HTML Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          chmod 644 *.html 2>/dev/null || echo "No HTML files to set permissions"
          
          echo "âœ… File permissions set"
          
          # ĞŸĞ¾ĞºĞ°Ğ·Ñ‹Ğ²Ğ°ĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ²
          echo "ğŸ“‹ Deployed files:"
          ls -la
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ¾ÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ñ„Ğ°Ğ¹Ğ»Ñ‹
          if [ -f "index.html" ]; then
            echo "âœ… index.html deployed successfully"
          else
            echo "âŒ index.html not found after deployment!"
          fi
          
          echo "ğŸ‰ Deployment completed successfully!"
          echo "ğŸ“ Files deployed to: ${{ secrets.SERVER_PATH }}/current"
          echo "ğŸŒ Site should be available at your domain"
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾Ğ¼ Ğ´ĞµĞ¿Ğ»Ğ¾Ğµ
    - name: Deployment notification
      if: success()
      run: |
        echo "ğŸ‰ Static site deployment successful!"
        echo "âœ… Dialist has been deployed to the server"
        echo "ğŸ”— Check your website to see the changes"
        echo "ğŸ“Š Deployment completed at $(date)"
    
    # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ğ± Ğ¾ÑˆĞ¸Ğ±ĞºĞµ
    - name: Deployment failed notification
      if: failure()
      run: |
        echo "âŒ Static site deployment failed!"
        echo "ğŸ” Check the logs above for details"
        echo "ğŸ’¡ Common issues:"
        echo "   - Check SSH connection settings"
        echo "   - Verify server path exists"
        echo "   - Ensure proper file permissions"